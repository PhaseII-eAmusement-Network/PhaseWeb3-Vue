import{a as ee,b as te,a4 as le,r as y,n as j,D as ae,o as re,c as x,d as r,w as m,e as s,_ as se,f as p,i as o,g as _,j as v,J as B,h as $,F as R,k as M,t as h,l as V,y as I,m as ie,aL as A,aS as D}from"./index-BK8JKmkz.js";import{I as ne}from"./PhPlusCircle.vue-7NUa9DcX.js";import{_ as oe,G as ue}from"./GameHeader-DCOh9eXM.js";import{_ as W}from"./BaseButtons-C0XVogEK.js";import{_ as ce}from"./ProfileCard-DUbntPFG.js";import{_ as X}from"./FormControl-BxiH51OX.js";import{_ as de}from"./FormField-ie9sADLq.js";import{A as ve,d as fe,a as me,e as _e,c as J,f as pe}from"./profile-BPIGt4nc.js";import{d as he}from"./userData-DZYdegtD.js";import"./PhGear.vue-DOgW6qeF.js";import"./PhHouse.vue-FfAksSEk.js";const ge={key:0,class:"w-full md:flex md:-mt-[75px] mb-4 place-content-end"},ye={class:"md:w-1/3 md:text-right"},xe={key:1,class:"w-full"},Ve={class:"grid gap-4"},ke={class:"grid md:flex gap-2 w-full place-content-between"},we={class:"text-lg md:text-xl"},Re={class:"text-md md:text-lg font-mono"},be={class:"text-xl rounded-2xl p-4 my-2 bg-slate-900"},Ie={class:"grid gap-3"},Ae={class:"grid gap-2 md:flex justify-between items-center"},De={class:"flex"},Ce={class:"text-lg"},Pe={key:0,class:"text-emerald-500"},$e={key:1,class:"text-red-500"},Se={key:0,class:"text-xl"},Te={__name:"RivalsView",setup(Le){const T=ee(),S=te();var i=null,n=null;i=T.params.game,n=le(i);const d=y(null),u=y(null),L=y([]),a=j({currentVersion:null}),b=y(null),C=y(null),g=y(null);ae(()=>a.currentVersion,()=>{N(),F(),O(),H()}),re(async()=>{await k()}),n.versions||(a.currentVersion=1);async function k(){O(),await N(),F(),w.filter=null}async function N(){try{d.value=null;const t=await ve(i,a.currentVersion);d.value=t,t&&!a.currentVersion&&(a.currentVersion=t.versions[t.versions.length-1]),n.useActiveRival&&K()}catch(t){console.error("Failed to fetch user profile data:",t)}}async function F(){try{u.value=null;var t=await fe(i,a.currentVersion);u.value=t}catch(e){console.error("Failed to fetch user link data:",e)}}async function O(){try{const t=await me(i,a.currentVersion);L.value=t}catch(t){console.error("Failed to fetch profile data:",t)}}function E(t){var e=[];for(const l of n.versions)t.includes(l.id)&&e.push(l);return e}const w=j({filter:null});n||S.push({name:"ErrorPage",params:{catchAll:"404"}});function q(){var t=JSON.parse(JSON.stringify(w.filter));if(t)return t=t.replace(/-/g,""),L.value.filter(e=>e.username.toLowerCase().includes(t.toLowerCase())||e.extid.toString().toLowerCase().includes(t.toLowerCase()))}function z(t){return t==d.value?.userId?!0:u.value==null?!1:u.value.length>=b.value?!0:u.value.some(e=>e.otherUserId===t)}function H(){const t=n.versions.find(e=>e.id==a.currentVersion);b.value=t?.maxRivals??3,C.value=t?.maxActiveRivals??3}function K(){if(!d.value?.last){g.value=[];return}var t=[];const e=["fri","rival1","rival2","rival3"];for(const l of e){const c=d.value?.last[l];c>=1&&t.push(c)}g.value=t}async function Q(t){if(!(u.value&&u.value.length>=b.value)){var e="rival";if(n?.useActiveRival){const c=new Set((u.value??[]).map(f=>f?.type?.startsWith("friend_")?parseInt(f.type.replace("friend_",""),10):null).filter(f=>f!==null&&!isNaN(f)));var l=null;for(let f=0;f<=9;f++)if(!c.has(f)){l=f;break}e=`friend_${l}`}try{await _e(i,a.currentVersion,t,e),await k()}catch(c){console.error("Failed to add rival:",c)}}}async function Y(t,e){try{await pe(i,a.currentVersion,t,e)&&n.useActiveRival&&await G(e),await k()}catch(l){console.error("Failed to delete rival:",l)}}async function Z(t){var e=d.value?.last??{},l=null;if(t.startsWith("friend_"))l=parseInt(t.replace("friend_",""),10);else return;[A.DDR,A.DDROMNI].includes(i)&&([D.DDR_X,D.DDR_X2].includes(a.currentVersion)?e.fri=l+1:!e.rival1||e.rival1<1?e.rival1=l+1:!e.rival2||e.rival2<1?e.rival2=l+1:(!e.rival3||e.rival3<1)&&(e.rival3=l+1)),await J(i,a.currentVersion,{last:e}),await k()}async function G(t){var e=d.value?.last??{},l=null;if(t.startsWith("friend_"))l=parseInt(t.replace("friend_",""),10);else return;[A.DDR,A.DDROMNI].includes(i)&&([D.DDR_X,D.DDR_X2].includes(a.currentVersion)?e.fri===l+1&&(e.fri=0):e.rival1===l+1?e.rival1=0:e.rival2===l+1?e.rival2=0:e.rival3===l+1&&(e.rival3=0)),await J(i,a.currentVersion,{last:e}),await k()}const P=t=>{if(t.startsWith("friend_"))return parseInt(t.replace("friend_",""),10)+1},U=t=>{S.push(`/games/${i}/profiles/${t}`)};return(t,e)=>(r(),x(ie,null,{default:m(()=>[s(se,null,{default:m(()=>[s(oe,{game:_(n),version:a.currentVersion},{default:m(()=>[_(n).versions&&d.value?(r(),v("div",ge,[o("div",ye,[e[2]||(e[2]=o("h2",{class:"text-md sm:text-lg md:text-xl font-bold p-2"}," Select Version ",-1)),s(X,{modelValue:a.currentVersion,"onUpdate:modelValue":e[0]||(e[0]=l=>a.currentVersion=l),options:E(d.value.versions)},null,8,["modelValue","options"])])])):p("",!0),d.value?(r(),v("div",xe,[s(ce,{game:_(i),version:a.currentVersion,profile:d.value},null,8,["game","version","profile"])])):p("",!0)]),_:1},8,["game","version"]),s(B,{icon:_(ne),title:"Add a Rival",main:""},null,8,["icon"]),a.currentVersion?(r(),x($,{key:0,class:"mb-6"},{default:m(()=>[s(de,{label:"Search",help:"Search by username or Rival ID to add a rival.",class:"w-full md:w-1/3"},{default:m(()=>[s(X,{modelValue:w.filter,"onUpdate:modelValue":e[1]||(e[1]=l=>w.filter=l),"model-value":w.filter,placeholder:"1234-5678"},null,8,["modelValue","model-value"])]),_:1}),o("div",Ve,[(r(!0),v(R,null,M(q(),l=>(r(),v("div",{key:l.id,class:"bg-slate-800 p-4 rounded-xl"},[o("div",ke,[o("div",null,[o("h1",we,h(l.username),1),o("h2",Re,h(_(he)(l.extid)),1)]),s(W,null,{default:m(()=>[s(V,{label:"Open Profile",color:"info",onClick:c=>U(l.userId)},null,8,["onClick"]),s(V,{label:"Add Rival",color:"success",disabled:z(l.userId),onClick:c=>Q(l.userId)},null,8,["disabled","onClick"])]),_:2},1024)])]))),128))])]),_:1})):p("",!0),s(B,{icon:_(ue),title:"Rivals",main:""},null,8,["icon"]),o("h2",be,[I(h(u.value?.length??0)+" / "+h(b.value)+" added ",1),_(n)?.useActiveRival?(r(),v(R,{key:0},[e[3]||(e[3]=I(" - ",-1)),o("span",null,h(g.value?.length??0)+" / "+h(C.value)+" active",1)],64)):p("",!0)]),a.currentVersion?(r(),x($,{key:1,class:"mb-6"},{default:m(()=>[o("div",Ie,[(r(!0),v(R,null,M(u.value,l=>(r(),x($,{key:P(l?.type),"color-prop":"bg-slate-800 dark:bg-slate-800"},{default:m(()=>[o("div",Ae,[o("div",De,[o("h1",Ce,[I(h(l?.otherProfileData?.username)+" ",1),_(n)?.useActiveRival?(r(),v(R,{key:0},[e[4]||(e[4]=I(" - ",-1)),g.value.includes(P(l?.type))?(r(),v("span",Pe,"Active")):(r(),v("span",$e,"Inactive"))],64)):p("",!0)])]),s(W,null,{default:m(()=>[s(V,{label:"Open Profile",color:"info",onClick:c=>U(l?.otherUserId)},null,8,["onClick"]),_(n)?.useActiveRival?(r(),v(R,{key:0},[g.value.includes(P(l?.type))?(r(),x(V,{key:0,label:"Set Inactive",color:"warning",onClick:c=>G(l?.type)},null,8,["onClick"])):(r(),x(V,{key:1,label:"Set Active",color:"success",disabled:g.value.length>=C.value,onClick:c=>Z(l?.type)},null,8,["disabled","onClick"]))],64)):p("",!0),s(V,{label:"Remove Rival",color:"danger",onClick:c=>Y(l?.otherUserId,l?.type)},null,8,["onClick"])]),_:2},1024)])]),_:2},1024))),128)),!u.value||!u.value.length?(r(),v("span",Se,"No rivals!")):p("",!0)])]),_:1})):p("",!0)]),_:1})]),_:1}))}};export{Te as default};

import{l as te,m as le,ab as ae,r as h,B as M,Q as re,o as se,c as V,a as r,w as m,b as s,_ as ie,e as p,p as o,g as _,d,f as W,n as $,F as R,h as X,t as g,q as j,s as x,M as I,k as ne,aS as A,b3 as D}from"./index-D9SORqzk.js";import{I as oe}from"./PhPlusCircle.vue-BCNoo5vq.js";import{_ as ue,G as ce}from"./GameHeader-o1Hcf0DZ.js";import{_ as de}from"./ProfileCard-BXG_Q57a.js";import{_ as T}from"./FormControl-BerDdVCg.js";import{_ as ve}from"./FormField-DiqkXYVL.js";import{A as fe,d as me,a as _e,e as pe,c as E,f as he}from"./profile-4n-4ItW4.js";import{d as ge}from"./userData-DZYdegtD.js";import"./PhGear.vue-Cq1XWPzU.js";import"./PhHouse.vue-r_0YgvZ8.js";const ye={key:0,class:"w-full md:flex md:-mt-[75px] mb-4 place-content-end"},Ve={class:"md:w-1/3 md:text-right"},xe={key:1,class:"w-full"},ke={class:"grid gap-4"},we={class:"grid md:flex gap-2 w-full place-content-between"},Re={class:"text-lg md:text-xl"},be={class:"text-md md:text-lg font-mono"},Ie={class:"text-xl rounded-2xl p-4 my-2 bg-slate-900"},Ae={class:"grid gap-3"},De={class:"grid gap-2 md:flex justify-between items-center"},Ce={class:"flex"},Pe={class:"text-lg"},$e={key:0,class:"text-emerald-500"},Se={key:1,class:"text-red-500"},Ne={key:0,class:"text-xl"},Ee={__name:"RivalsView",setup(Le){const J=te(),S=le();var i=null,n=null;i=J.params.game,n=ae(i);const v=h(null),N=h(null),u=h(null),L=h([]),a=M({currentVersion:null}),b=h(null),C=h(null),y=h(null);re(()=>a.currentVersion,()=>{F(),G(),O(),H()}),se(async()=>{await k()}),n.versions||(a.currentVersion=1);async function k(){O(),await F(),G(),w.filter=null}async function F(){try{v.value=null;const t=await fe(i,a.currentVersion);v.value=t.profile,N.value=t.versions,t&&!a.currentVersion&&(a.currentVersion=t.versions[t.versions.length-1]),n.useActiveRival&&K()}catch(t){console.error("Failed to fetch user profile data:",t)}}async function G(){try{u.value=null;var t=await me(i,a.currentVersion);u.value=t}catch(e){console.error("Failed to fetch user link data:",e)}}async function O(){try{const t=await _e(i,a.currentVersion);L.value=t.profiles}catch(t){console.error("Failed to fetch profile data:",t)}}function q(t){var e=[];for(const l of n.versions)t.includes(l.id)&&e.push(l);return e}const w=M({filter:null});n||S.push({name:"ErrorPage",params:{catchAll:"404"}});function Q(){var t=JSON.parse(JSON.stringify(w.filter));if(t)return t=t.replace(/-/g,""),L.value.filter(e=>e.username.toLowerCase().includes(t.toLowerCase())||e.extid.toString().toLowerCase().includes(t.toLowerCase()))}function z(t){return t==v.value?.userId?!0:u.value==null?!1:u.value.length>=b.value?!0:u.value.some(e=>e.otherUserId===t)}function H(){const t=n.versions.find(e=>e.id==a.currentVersion);b.value=t?.maxRivals??3,C.value=t?.maxActiveRivals??3}function K(){if(!v.value?.last){y.value=[];return}var t=[];const e=["fri","rival1","rival2","rival3"];for(const l of e){const c=v.value?.last[l];c>=1&&t.push(c)}y.value=t}async function Y(t){if(!(u.value&&u.value.length>=b.value)){var e="rival";if(n?.useActiveRival){const c=new Set((u.value??[]).map(f=>f?.type?.startsWith("friend_")?parseInt(f.type.replace("friend_",""),10):null).filter(f=>f!==null&&!isNaN(f)));var l=null;for(let f=0;f<=9;f++)if(!c.has(f)){l=f;break}e=`friend_${l}`}try{await pe(i,a.currentVersion,t,e),await k()}catch(c){console.error("Failed to add rival:",c)}}}async function Z(t,e){try{await he(i,a.currentVersion,t,e)&&n.useActiveRival&&await U(e),await k()}catch(l){console.error("Failed to delete rival:",l)}}async function ee(t){var e=v.value?.last??{},l=null;if(t.startsWith("friend_"))l=parseInt(t.replace("friend_",""),10);else return;[A.DDR,A.DDROMNI].includes(i)&&([D.DDR_X,D.DDR_X2].includes(a.currentVersion)?e.fri=l+1:!e.rival1||e.rival1<1?e.rival1=l+1:!e.rival2||e.rival2<1?e.rival2=l+1:(!e.rival3||e.rival3<1)&&(e.rival3=l+1)),await E(i,a.currentVersion,{last:e}),await k()}async function U(t){var e=v.value?.last??{},l=null;if(t.startsWith("friend_"))l=parseInt(t.replace("friend_",""),10);else return;[A.DDR,A.DDROMNI].includes(i)&&([D.DDR_X,D.DDR_X2].includes(a.currentVersion)?e.fri===l+1&&(e.fri=0):e.rival1===l+1?e.rival1=0:e.rival2===l+1?e.rival2=0:e.rival3===l+1&&(e.rival3=0)),await E(i,a.currentVersion,{last:e}),await k()}const P=t=>{if(t.startsWith("friend_"))return parseInt(t.replace("friend_",""),10)+1},B=t=>{S.push(`/games/${i}/profiles/${t}`)};return(t,e)=>(r(),V(ne,null,{default:m(()=>[s(ie,null,{default:m(()=>[s(ue,{game:_(n),version:a.currentVersion},{default:m(()=>[_(n).versions&&v.value?(r(),d("div",ye,[o("div",Ve,[e[2]||(e[2]=o("h2",{class:"text-md sm:text-lg md:text-xl font-bold p-2"}," Select Version ",-1)),s(T,{modelValue:a.currentVersion,"onUpdate:modelValue":e[0]||(e[0]=l=>a.currentVersion=l),options:q(N.value)},null,8,["modelValue","options"])])])):p("",!0),v.value?(r(),d("div",xe,[s(de,{game:_(i),version:a.currentVersion,profile:v.value},null,8,["game","version","profile"])])):p("",!0)]),_:1},8,["game","version"]),s(W,{icon:_(oe),title:"Add a Rival",main:""},null,8,["icon"]),a.currentVersion?(r(),V($,{key:0,class:"mb-6"},{default:m(()=>[s(ve,{label:"Search",help:"Search by username or Rival ID to add a rival.",class:"w-full md:w-1/3"},{default:m(()=>[s(T,{modelValue:w.filter,"onUpdate:modelValue":e[1]||(e[1]=l=>w.filter=l),"model-value":w.filter,placeholder:"1234-5678"},null,8,["modelValue","model-value"])]),_:1}),o("div",ke,[(r(!0),d(R,null,X(Q(),l=>(r(),d("div",{key:l.id,class:"bg-slate-800 p-4 rounded-xl"},[o("div",we,[o("div",null,[o("h1",Re,g(l.username),1),o("h2",be,g(_(ge)(l.extid)),1)]),s(j,null,{default:m(()=>[s(x,{label:"Open Profile",color:"info",onClick:c=>B(l.userId)},null,8,["onClick"]),s(x,{label:"Add Rival",color:"success",disabled:z(l.userId),onClick:c=>Y(l.userId)},null,8,["disabled","onClick"])]),_:2},1024)])]))),128))])]),_:1})):p("",!0),s(W,{icon:_(ce),title:"Rivals",main:""},null,8,["icon"]),o("h2",Ie,[I(g(u.value?.length??0)+" / "+g(b.value)+" added ",1),_(n)?.useActiveRival?(r(),d(R,{key:0},[e[3]||(e[3]=I(" - ",-1)),o("span",null,g(y.value?.length??0)+" / "+g(C.value)+" active",1)],64)):p("",!0)]),a.currentVersion?(r(),V($,{key:1,class:"mb-6"},{default:m(()=>[o("div",Ae,[(r(!0),d(R,null,X(u.value,l=>(r(),V($,{key:P(l?.type),"color-prop":"bg-slate-800 dark:bg-slate-800"},{default:m(()=>[o("div",De,[o("div",Ce,[o("h1",Pe,[I(g(l?.otherProfileData?.username)+" ",1),_(n)?.useActiveRival?(r(),d(R,{key:0},[e[4]||(e[4]=I(" - ",-1)),y.value.includes(P(l?.type))?(r(),d("span",$e,"Active")):(r(),d("span",Se,"Inactive"))],64)):p("",!0)])]),s(j,null,{default:m(()=>[s(x,{label:"Open Profile",color:"info",onClick:c=>B(l?.otherUserId)},null,8,["onClick"]),_(n)?.useActiveRival?(r(),d(R,{key:0},[y.value.includes(P(l?.type))?(r(),V(x,{key:0,label:"Set Inactive",color:"warning",onClick:c=>U(l?.type)},null,8,["onClick"])):(r(),V(x,{key:1,label:"Set Active",color:"success",disabled:y.value.length>=C.value,onClick:c=>ee(l?.type)},null,8,["disabled","onClick"]))],64)):p("",!0),s(x,{label:"Remove Rival",color:"danger",onClick:c=>Z(l?.otherUserId,l?.type)},null,8,["onClick"])]),_:2},1024)])]),_:2},1024))),128)),!u.value||!u.value.length?(r(),d("span",Ne,"No rivals!")):p("",!0)])]),_:1})):p("",!0)]),_:1})]),_:1}))}};export{Ee as default};
